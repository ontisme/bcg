import{_ as we}from"./Dialog-DN-QtVp0.js";import{a as ee,c as X,b5 as Me,b as te,e as ke,u as Se,f as oe,h as N,aO as Ce,a4 as _e,i as ze,l as g,V as Oe,j,aQ as je,a7 as De,bO as Ie,_ as Ye,ak as $e,ag as E,o as Xe,y as H,m as Ne,z as T,A as ae,B as W,J as C,bP as ne,F as se,I as U,C as P,ai as Ee,E as R,bE as Re,G as Te,H as We,D as Pe,al as Be,am as Ve}from"./index-CGAq74Qo.js";import{u as Le}from"./use-compitable-TQif5LUF.js";import{N as He,a as Ue}from"./ListItem-Du_QBgfv.js";const Fe=ee([ee("@keyframes spin-rotate",`
 from {
 transform: rotate(0);
 }
 to {
 transform: rotate(360deg);
 }
 `),X("spin-container",`
 position: relative;
 `,[X("spin-body",`
 position: absolute;
 top: 50%;
 left: 50%;
 transform: translateX(-50%) translateY(-50%);
 `,[Me()])]),X("spin-body",`
 display: inline-flex;
 align-items: center;
 justify-content: center;
 flex-direction: column;
 `),X("spin",`
 display: inline-flex;
 height: var(--n-size);
 width: var(--n-size);
 font-size: var(--n-size);
 color: var(--n-color);
 `,[te("rotate",`
 animation: spin-rotate 2s linear infinite;
 `)]),X("spin-description",`
 display: inline-block;
 font-size: var(--n-font-size);
 color: var(--n-text-color);
 transition: color .3s var(--n-bezier);
 margin-top: 8px;
 `),X("spin-content",`
 opacity: 1;
 transition: opacity .3s var(--n-bezier);
 pointer-events: all;
 `,[te("spinning",`
 user-select: none;
 -webkit-user-select: none;
 pointer-events: none;
 opacity: var(--n-opacity-spinning);
 `)])]),Ge={small:20,medium:18,large:16},Ae=Object.assign(Object.assign({},oe.props),{contentClass:String,contentStyle:[Object,String],description:String,stroke:String,size:{type:[String,Number],default:"medium"},show:{type:Boolean,default:!0},strokeWidth:Number,rotate:{type:Boolean,default:!0},spinning:{type:Boolean,validator:()=>!0,default:void 0},delay:Number}),Je=ke({name:"Spin",props:Ae,setup(u){const{mergedClsPrefixRef:D,inlineThemeDisabled:d}=Se(u),h=oe("Spin","-spin",Fe,Ie,u,D),w=N(()=>{const{size:m}=u,{common:{cubicBezierEaseInOut:k},self:y}=h.value,{opacitySpinning:M,color:o,textColor:Y}=y,$=typeof m=="number"?Ce(m):y[_e("size",m)];return{"--n-bezier":k,"--n-opacity-spinning":M,"--n-size":$,"--n-color":o,"--n-text-color":Y}}),x=d?ze("spin",N(()=>{const{size:m}=u;return typeof m=="number"?String(m):m[0]}),w,u):void 0,v=Le(u,["spinning","show"]),S=g(!1);return Oe(m=>{let k;if(v.value){const{delay:y}=u;if(y){k=window.setTimeout(()=>{S.value=!0},y),m(()=>{clearTimeout(k)});return}}S.value=v.value}),{mergedClsPrefix:D,active:S,mergedStrokeWidth:N(()=>{const{strokeWidth:m}=u;if(m!==void 0)return m;const{size:k}=u;return Ge[typeof k=="number"?"medium":k]}),cssVars:d?void 0:w,themeClass:x==null?void 0:x.themeClass,onRender:x==null?void 0:x.onRender}},render(){var u,D;const{$slots:d,mergedClsPrefix:h,description:w}=this,x=d.icon&&this.rotate,v=(w||d.description)&&j("div",{class:`${h}-spin-description`},w||((u=d.description)===null||u===void 0?void 0:u.call(d))),S=d.icon?j("div",{class:[`${h}-spin-body`,this.themeClass]},j("div",{class:[`${h}-spin`,x&&`${h}-spin--rotate`],style:d.default?"":this.cssVars},d.icon()),v):j("div",{class:[`${h}-spin-body`,this.themeClass]},j(je,{clsPrefix:h,style:d.default?"":this.cssVars,stroke:this.stroke,"stroke-width":this.mergedStrokeWidth,class:`${h}-spin`}),v);return(D=this.onRender)===null||D===void 0||D.call(this),d.default?j("div",{class:[`${h}-spin-container`,this.themeClass],style:this.cssVars},j("div",{class:[`${h}-spin-content`,this.active&&`${h}-spin-content--spinning`,this.contentClass],style:this.contentStyle},d),j(De,{name:"fade-in-transition"},{default:()=>this.active?S:null})):S}}),ie=u=>(Be("data-v-1ce9f419"),u=u(),Ve(),u),Ke={class:"crosshair-container"},qe={key:0,class:"loading-overlay"},Qe=ie(()=>C("p",null,"加載地圖數據中...",-1)),Ze={class:"mouse-position"},et={class:"map-sidebar"},tt=ie(()=>C("h3",null,"特殊對象",-1)),at={__name:"GameMap",props:{username:String},emits:["close"],setup(u,{emit:D}){const d=u,h=$e(),w=E({x:0,y:0}),x=E({x:0,y:0}),v=E({x:0,y:0}),S=g(""),m=g(""),k=g([]),y=g(null),M=g(null),o=g(1),Y=g(!1),$=g({x:0,y:0}),c=E({x:500,y:500}),B=g(!0),F=g(""),G=g(!1),le=N(()=>{const e=G.value?"迷宮地圖":"固定地圖";return`遊戲地圖 - ${S.value} [${m.value}] (${v.x}, ${v.y}) - ${e}`}),I=g(null),n=g(10),A=E({value:{}}),_={kObjectUnknown:255,kObjectEmpty:0,kObjectWater:1,kObjectWall:2,kObjectRock:3,kObjectRockEx:4,kObjectRoad:5,kObjectUp:6,kObjectDown:7,kObjectJump:8,kObjectWarp:9,kObjectBoundary:10},J=["#000000","#404a29","#333333","#232323","#51331a","#404a29","#ff8080","#8080ff","#ffff00","#ffff00","#000000"];function ce(){return new Promise((e,t)=>{console.log("Getting map data for:",d.username);const a=h.getMapData(d.username);if(console.log("Compressed data:",a),!a){t(new Error("No map data found"));return}try{K(),G.value=a.header.isMaze==="1",A.value=a.header,e(a)}catch(s){console.error("Error decompressing map data:",s),t(s)}})}function re(e){const t=e.header,a=e.mapData;if(!t||!a)throw new Error("Invalid map data: missing header or mapData");const s=new Map;let i=1/0,r=1/0,f=-1/0,b=-1/0;for(let l=0;l<a.length;l++)for(let p=0;p<a[l].length;p++){const O=a[l][p];O!==_.kObjectEmpty&&(s.set(`${p},${l}`,O),i=Math.min(i,p),r=Math.min(r,l),f=Math.max(f,p),b=Math.max(b,l))}k.value=[];for(let l=0;l<e.mapData.length;l++)for(let p=0;p<e.mapData[l].length;p++){const O=e.mapData[l][p];[6,7,8,9].includes(O)&&k.value.push({id:`${p}-${l}`,name:ue(O),x:p,y:l})}return{header:t,mapData:s,bounds:{minX:i,minY:r,maxX:f,maxY:b},width:a[0].length,height:a.length}}function ue(e){switch(e){case _.kObjectUp:return"上樓";case _.kObjectDown:return"下樓";case _.kObjectJump:case _.kObjectWarp:return"傳點";default:return be(e)}}function ve(e){return new Promise(t=>{const a=new OffscreenCanvas(e.width*n.value,e.height*n.value),s=a.getContext("2d");s.fillStyle=J[_.kObjectEmpty],s.fillRect(0,0,a.width,a.height);for(const[i,r]of e.mapData){const[f,b]=i.split(",").map(Number);s.fillStyle=J[r]||"#1e1e1e",s.fillRect(f*n.value,b*n.value,n.value,n.value)}t(a)})}async function V(){if(!y.value){console.error("Map container is not available");return}B.value=!0,F.value="";try{const e=await ce();if(!e)throw new Error("No map data received");const t=re(e);I.value=await ve(t);const{bounds:a}=t;c.x=(a.minX+a.maxX)/2,c.y=(a.minY+a.maxY)/2;const s=a.maxX-a.minX+1,i=a.maxY-a.minY+1,r=y.value.clientWidth/(s*n.value),f=y.value.clientHeight/(i*n.value);o.value=Math.min(r,f)*.9,z()}catch(e){console.error("Error initializing map:",e),F.value=`Error loading map: ${e.message}`}finally{B.value=!1}}function z(){if(!M.value||!I.value)return;const e=M.value,t=e.getContext("2d");t.clearRect(0,0,e.width,e.height);const a=Math.ceil(e.width/(n.value*o.value)),s=Math.ceil(e.height/(n.value*o.value)),i=Math.max(0,Math.floor(c.x-a/2)),r=Math.max(0,Math.floor(c.y-s/2)),f=Math.min(I.value.width/n.value,i+a),b=Math.min(I.value.height/n.value,r+s),l=e.width/2-(c.x-i)*n.value*o.value,p=e.height/2-(c.y-r)*n.value*o.value;t.imageSmoothingEnabled=!1,t.drawImage(I.value,i*n.value,r*n.value,(f-i)*n.value,(b-r)*n.value,l,p,(f-i)*n.value*o.value,(b-r)*n.value*o.value);const O=(v.x-i+.5)*n.value*o.value+l,Q=(v.y-r+.5)*n.value*o.value+p,Z=Math.max(n.value*o.value,10);t.fillStyle="rgba(255, 0, 0, 0.7)",t.beginPath(),t.arc(O,Q,Z/2,0,2*Math.PI),t.fill(),t.strokeStyle="white",t.lineWidth=2,t.stroke(),t.fillStyle="white",t.beginPath(),t.arc(O,Q,Z/6,0,2*Math.PI),t.fill()}const de=N(()=>{const e=M.value;return e?{top:`${(v.y-c.y+.5)*n.value*o.value+e.height/2}px`}:{top:"50%"}}),me=N(()=>{const e=M.value;return e?{left:`${(v.x-c.x+.5)*n.value*o.value+e.width/2}px`}:{left:"50%"}});function he(){Y.value=!1,w.x=-1e3,w.y=-1e3}function L(){if(!y.value||!M.value)return;const e=M.value;e.width=y.value.clientWidth,e.height=y.value.clientHeight,z()}function fe(e){const t=M.value,a=t.getBoundingClientRect();if(w.x=e.clientX-a.left,w.y=e.clientY-a.top,x.x=Math.floor(c.x+(w.x-t.width/2)/(n.value*o.value)),x.y=Math.floor(c.y+(w.y-t.height/2)/(n.value*o.value)),Y.value){const s=(e.clientX-$.value.x)/(n.value*o.value),i=(e.clientY-$.value.y)/(n.value*o.value);c.x=Math.max(0,Math.min(I.value.width/n.value,c.x-s)),c.y=Math.max(0,Math.min(I.value.height/n.value,c.y-i)),$.value={x:e.clientX,y:e.clientY},requestAnimationFrame(z)}}function pe(e){e.preventDefault();const t=e.deltaY>0?.9:1.1,a=Math.max(.1,Math.min(5,o.value*t)),s=M.value.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,f=c.x+(i-s.width/2)/(n.value*o.value),b=c.y+(r-s.height/2)/(n.value*o.value);c.x=f-(i-s.width/2)/(n.value*a),c.y=b-(r-s.height/2)/(n.value*a),o.value=a,z()}function ye(e){console.log("Clicked item:",e)}function ge(e){Y.value=!0,$.value={x:e.clientX,y:e.clientY}}function xe(){Y.value=!1}function be(e){return Object.keys(_).find(t=>_[t]===e)||"Unknown"}function K(){var t,a,s,i;console.log("Updating character info");const e=h.getAccountData(d.username);if(e&&e.gameInfo){const r=((t=e.gameInfo.locate)==null?void 0:t.x)||0,f=((a=e.gameInfo.locate)==null?void 0:a.y)||0,b=((s=e.gameInfo.map)==null?void 0:s.mapName)||"Unknown Map",l=((i=e.gameInfo.map)==null?void 0:i.floor)||-1;(v.x!==r||v.y!==f||S.value!==b||m.value!==l)&&(v.x=r,v.y=f,m.value!==l?(S.value=b,m.value=l,V()):z())}}let q=null;return Xe(async()=>{y.value&&M.value?(await V(),window.addEventListener("resize",L),L(),c.x=v.x,c.y=v.y,z()):console.error("Map container or canvas is not available on mount"),q=setInterval(K,500)}),H(o,z),H(v,()=>{z()}),H(A.value,()=>{console.log(123),V()}),Ne(()=>{window.removeEventListener("resize",L),clearInterval(q)}),(e,t)=>{const a=we;return T(),ae(a,{title:le.value,onClose:t[0]||(t[0]=s=>e.$emit("close"))},{default:W(()=>[C("div",{ref_key:"mapContainer",ref:y,class:"map-container"},[C("canvas",{ref_key:"mapCanvas",ref:M,onMousedown:ge,onMousemove:fe,onMouseup:xe,onMouseleave:he,onWheel:pe},null,544),C("div",Ke,[C("div",{class:"crosshair-h",style:ne(de.value)},null,4),C("div",{class:"crosshair-v",style:ne(me.value)},null,4)]),B.value?(T(),se("div",qe,[U(P(Je),{size:"large"}),Qe])):Ee("",!0),C("div",Ze," 滑鼠位置: ("+R(x.x)+", "+R(x.y)+") ",1)],512),C("div",et,[tt,U(P(Re),{style:{flex:"1"}},{default:W(()=>[U(P(He),{hoverable:"",clickable:""},{default:W(()=>[(T(!0),se(Te,null,We(k.value,s=>(T(),ae(P(Ue),{key:s.id,onClick:i=>ye(s)},{default:W(()=>[Pe(R(s.name)+" ("+R(s.x)+", "+R(s.y)+") ",1)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1})])]),_:1},8,["title"])}}},ct=Ye(at,[["__scopeId","data-v-1ce9f419"]]);export{ct as default};
